<script>
  const button = document.getElementById("listenBtn");
  const result = document.getElementById("result");
  const voiceSelect = document.getElementById("voiceSelect");

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const synth = window.speechSynthesis;
  let selectedVoice = null;

  function populateVoices() {
    const voices = synth.getVoices();
    if (!voices.length) {
      // Try again shortly if voices not yet loaded
      setTimeout(populateVoices, 200);
      return;
    }

    voiceSelect.innerHTML = "";
    voices.forEach((voice, i) => {
      const option = document.createElement("option");
      option.value = i;
      option.textContent = `${voice.name} (${voice.lang})`;
      voiceSelect.appendChild(option);
    });

    // Auto-select an English (UK) voice if possible
    const ukVoiceIndex = voices.findIndex(v => v.lang === "en-GB");
    voiceSelect.value = ukVoiceIndex >= 0 ? ukVoiceIndex : 0;
    selectedVoice = voices[voiceSelect.value];
  }

  // Load voices on page load and when available
  populateVoices();
  synth.onvoiceschanged = populateVoices;

  voiceSelect.addEventListener("change", () => {
    const voices = synth.getVoices();
    selectedVoice = voices[voiceSelect.value];
  });

  if (!SpeechRecognition) {
    result.textContent = "Speech recognition not supported on this device.";
    button.disabled = true;
  } else {
    const recognition = new SpeechRecognition();
    recognition.lang = "en-GB";
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    button.addEventListener("click", () => {
      result.textContent = "Listening...";
      recognition.start();
      // Trigger voices load if not yet populated
      if (!synth.getVoices().length) populateVoices();
    });

    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript;
      result.textContent = "You said: " + transcript;
      const utter = new SpeechSynthesisUtterance("You said: " + transcript);
      if (selectedVoice) utter.voice = selectedVoice;
      synth.speak(utter);
    };

    recognition.onerror = (event) => {
      result.textContent = "Error: " + event.error;
    };
  }
</script>
